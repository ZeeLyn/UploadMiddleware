window.WebUploader&&WebUploader.Uploader.register({"before-send":"beforeSend","before-send-file":"beforeSendFile","after-send-file":"afterSendFile"},{beforeSend:function(n){var t=n.file,r=t.options,i;return r.chunk.chunked?(t.chunks||(t.chunks=n.chunks),i=WebUploader.Deferred(),(new WebUploader.Uploader).md5File(t,n.start,n.end).then(function(u){$.ajax({type:"post",url:r.chunk.chunkCheckServerUrl,headers:{"file-md5":t.md5,"chunk-md5":u,chunk:n.chunk},success:function(n){n.exist?i.reject():i.resolve()},error:function(n){console.error(n);i.reject()}})}),i.promise()):!1},beforeSendFile:function(n){var i=n.options,t;return i.chunk.chunked?(t=WebUploader.Deferred(),(new WebUploader.Uploader).md5File(n).then(function(i){n.md5=i;t.resolve()}),t.promise()):!1},afterSendFile:function(n,t){var i=n.options,r;if(i.chunk.chunked)return r=WebUploader.Deferred(),$.ajax({type:"post",url:i.chunk.chunkMergeServerUrl,headers:{"file-md5":n.md5,chunks:n.chunks},success:function(t){if(i.container.find("#"+n.id).append('<input type="hidden" name="'+i.container.data("form-name")+'" value="'+t+'" />'),i.onUploaded)i.onUploaded(t);r.resolve()},error:function(n){console.error(n);r.reject()}}),r.promise();if(i.container.find("#"+n.id).append('<input type="hidden" name="'+i.container.data("form-name")+'" value="'+t[0]+'" />'),i.onUploaded)i.onUploaded(t[0])}}),function(n){n.fn.InitUploader=function(t){t=n.extend(!0,{data:null,container:this,fileBaseUrl:"",serverUrl:"/api/upload",multiple:!1,chunk:{chunked:!1,chunkSize:2097152,chunkCheckServerUrl:"/api/upload?action=chunk",chunkMergeServerUrl:"/api/upload?action=merge"},accept:{title:"Images",extensions:"gif,jpg,jpeg,bmp,png",mimeTypes:"image/*"},translation:{uploadBtnText:"开始上传",addFileBtnText:"添加文件",pauseBtnText:"暂停上传",continueBtnText:"继续上传",ExceedFileNumLimitAlert:"超出允许上传文件个数,最多只允许上传{FileNumLimit}个。",ExceedFileSizeLimitAlert:"超出允许上传的文件大小,单个文件大小不能超过{FileSizeLimit}。"},compress:!1,formData:null,fileNumLimit:1,fileSingleSizeLimit:4194304,threads:1,thumb:{width:100,height:100,quality:60,crop:!0,allowMagnify:!1},auto:!1,onFileQueued:null,onUploaded:null},t);var i;return this.each(function(){function it(i){var r=u('<li id="'+i.id+'" style="width:'+k+"px;height:"+d+'px;"><p class="imgWrap"><\/p><p class="progress"><span><\/span><\/p><\/li>'),e=u('<div class="file-panel"><span class="rotateLeft"><\/span><span class="rotateRight"><\/span><span class="cancel"><\/span><\/div>').appendTo(r),o=i.source.source,l=r.find("p.progress span"),f=r.find("p.imgWrap"),a=u('<p class="error"><\/p>'),h=function(n){switch(n){case"exceed_size":text="文件超出大小";break;case"interrupt":text="上传暂停";break;default:text="上传失败，请重试"}a.text(text).appendTo(r)};o.uploaded&&o.remote_url&&r.append('<input type="hidden" name="'+t.container.data("form-name")+'" value="'+o.remote_url+'" />');i.getStatus()==="invalid"?h(i.statusText):(f.text("Loading..."),n.makeThumb(i,function(n,t){if(n){f.empty().append(u('<img class="thumb" src="/auto-generate-html-control/resources/icons/'+i.ext+'.png">'));return}var r=u('<img src="'+t+'">');f.empty().append(r)},k,d),c[i.id]=[i.size,0],i.rotation=0);i.on("statuschange",function(n,t){t==="progress"?l.hide().width(0):t==="queued";n==="error"||n==="invalid"?(h(i.statusText),c[i.id][1]=1):n==="interrupt"?h("interrupt"):n==="queued"?c[i.id][1]=0:n==="progress"?(a.remove(),l.css("display","block")):n==="complete"&&r.append('<span class="success"><\/span>');r.removeClass("state-"+t).addClass("state-"+n)});r.on("mouseenter",function(){e.stop().animate({height:30})});r.on("mouseleave",function(){e.stop().animate({height:0})});e.on("click","span",function(){var r=u(this).index(),t;switch(r){case 0:i.rotation-=90;break;case 1:i.rotation+=90;break;case 2:n.removeFile(i);return}tt?(t="rotate("+i.rotation+"deg)",f.css({"-webkit-transform":t,"-mos-transform":t,"-o-transform":t,transform:t})):f.css("filter","progid:DXImageTransform.Microsoft.BasicImage(rotation="+~~(i.rotation/90%4+4)%4+")")});r.appendTo(s);i.source.source.uploaded&&i.setStatus("complete")}function rt(n){var t=e.find("#"+n.id);delete c[n.id];a();t.off().find(".file-panel").off().end().remove()}function a(){var i=0,n=0,r=y.children(),t;u.each(c,function(t,r){n+=r[0];i+=r[0]*r[1]});t=n?i/n:0;r.eq(0).text(Math.round(t*100)+"%");r.eq(1).css("width",Math.round(t*100)+"%");nt()}function nt(){var u="",i;r==="ready"?u="选中"+o+"个文件，共"+WebUploader.formatSize(p)+"。":r==="confirm"?(i=n.getStats(),i.uploadFailNum&&(u='成功 <span class="text-warning">'+i.successNum+'<\/span> 个，失败 <span class="text-success">'+i.uploadFailNum+'<\/span> 个，点击<a class="retry font-weight-bold" href="javascript:;"> 重新上传 <\/a>失败文件')):(i=n.getStats(),u="共"+o+"个（"+WebUploader.formatSize(p)+"），已上传"+(i.successNum-(t.data instanceof Array?t.data?t.data.length:0:1))+"个",i.uploadFailNum&&(u+="，失败"+i.uploadFailNum+"个"));b.html(u)}function l(i){var u;if(i!==r){f.removeClass("state-"+r);f.addClass("state-"+i);r=i;switch(r){case"pedding":v.removeClass("element-invisible");s.parent().removeClass("filled");s.hide();h.addClass("element-invisible");n.refresh();break;case"ready":v.addClass("element-invisible");w.removeClass("element-invisible");s.parent().addClass("filled");s.show();h.removeClass("element-invisible");n.refresh();break;case"uploading":w.addClass("element-invisible");y.show();f.text(t.translation.pauseBtnText);break;case"paused":y.show();f.text(t.translation.continueBtnText);break;case"confirm":if(y.hide(),f.text(t.translation.uploadBtnText).addClass("disabled"),u=n.getStats(),u.successNum&&!u.uploadFailNum){l("finish");return}break;case"finish":u=n.getStats();u.successNum||(r="done",location.reload())}nt()}}function ut(n,t,i){return fetch(n).then(function(n){return n.arrayBuffer()}).then(function(n){return new File([n],t,{type:i})})}var u=jQuery,e=t.container,s=e.find(".filelist"),h=e.find(".statusBar"),b=h.find(".info"),f=e.find(".uploadBtn"),v=e.find(".placeholder"),y=h.find(".progress").hide(),o=0,p=0,k=t.thumb.width,d=t.thumb.height,r="pedding",c={},tt=function(){var n=document.createElement("p").style,t="transition"in n||"WebkitTransition"in n||"MozTransition"in n||"msTransition"in n||"OTransition"in n;return n=null,t}(),w=e.find(".footer-add-btn"),n,g;if(!WebUploader.Uploader.support()){alert("WebUploader does not support the browser you are using.");throw new Error("WebUploader does not support the browser you are using.");}i=n=WebUploader.create({pick:{id:e.find(".filePicker"),label:t.translation.addFileBtnText,multiple:t.multiple},dnd:e.find(".queueList"),paste:t.container,accept:t.accept,auto:t.auto,formData:t.formData,disableGlobalDnd:!0,thumb:t.thumb,compress:t.compress,chunked:t.chunk.chunked,chunkSize:t.chunk.chunkSize,server:t.serverUrl,fileNumLimit:t.fileNumLimit,threads:t.threads,fileSingleSizeLimit:t.fileSingleSizeLimit});n.addButton({id:w,label:t.translation.addFileBtnText}).then(function(){w.find("div:eq(1)").css({width:"100%",height:"100%"})});t.data&&(g=t.data instanceof Array?t.data:[t.data],u(g).each(function(i,r){var u=r.split("/");ut(t.fileBaseUrl+r,u[u.length-1],"image/jpeg").then(function(t){t.uploaded=!0;t.remote_url=r;n.addFiles(t)})}));n.onUploadProgress=function(n,t){var i=u("#"+n.id),r=i.find(".progress span");r.css("width",t*100+"%");c[n.id][1]=t;a()};n.onBeforeFileQueued=function(){if(r==="finish")return!1};n.on("uploadBeforeSend",function(n,t,i){var r=n.file;i["file-md5"]=r.md5;i.chunk=n.chunk});n.onFileQueued=function(n){if(n.options=t,n.source.source.uploaded?(v.addClass("element-invisible"),h.show()):(o++,p+=n.size),o===1&&(v.addClass("element-invisible"),h.show(),f.removeClass("disabled")),it(n),l("ready"),a(),t.onFileQueued)t.onFileQueued(n)};n.onFileDequeued=function(n){n.source.source.uploaded||(o--,p-=n.size);rt(n);a();o<=0&&f.addClass("disabled");o<=0&&s.find("li").length===0&&l("pedding")};n.on("all",function(n){switch(n){case"uploadFinished":l("confirm");break;case"startUpload":l("uploading");break;case"stopUpload":l("paused")}});n.onError=function(n){switch(n){case"Q_EXCEED_NUM_LIMIT":alert(t.translation.ExceedFileNumLimitAlert.replace(/{FileNumLimit}/g,t.fileNumLimit));break;case"F_EXCEED_SIZE":alert(t.translation.ExceedFileSizeLimitAlert.replace(/{FileSizeLimit}/g,t.fileSingleSizeLimit/1024+"KB"));break;default:alert("Error: "+n)}};f.on("click",function(){if(u(this).hasClass("disabled"))return!1;r==="ready"?n.upload():r==="paused"?n.upload():r==="uploading"&&n.stop()});b.on("click",".retry",function(){n.retry()});f.addClass("state-"+r);a()}),{options:t,uploader:i}}}(jQuery);